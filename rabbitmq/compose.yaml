services:
  rabbitmq:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rabbitmq_01
    hostname: rabbitmq_node_01
    ports: 
      - "4369:4369"   # epmd - Erlang 端口映射守护进程
      - "5671:5671"   # AMQP over TLS
      - "5672:5672"   # AMQP 端口
      - "15671:15671" # 管理界面 HTTPS
      - "15672:15672" # 管理界面 HTTP
      - "25672:25672" # Erlang distribution - 节点间通信
      # - "15692:15692" # Prometheus metrics
    restart: unless-stopped
    
    volumes:
      - ../datas/rabbitmq/lib:/var/lib/rabbitmq
      - ./etc:/etc/rabbitmq
      - ../logs/rabbitmq:/var/log/rabbitmq
    
    environment:
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST:-cw_platform_test}
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-admin}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS:-rabbitmq123456}
      # 性能优化配置
      - RABBITMQ_VM_MEMORY_HIGH_WATERMARK=0.6
      - RABBITMQ_DISK_FREE_LIMIT=2GB
    
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # 资源限制（根据实际需求调整）
    # 开发环境配置 - 如需更多资源请取消注释下方配置
    deploy:
      resources:
        limits:
          cpus: '1.0'      # 最多使用 1 核 CPU
          memory: 1G       # 最多使用 1GB 内存
        reservations:
          cpus: '0.25'     # 保证 0.25 核
          memory: 256M     # 保证 256MB
    
    # 生产环境配置（取消下方注释并注释掉上方配置）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M
    
    networks:
      - rabbitmq-network

networks:
  rabbitmq-network:
    driver: bridge
    name: rabbitmq_network
