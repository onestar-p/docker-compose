# RabbitMQ é…ç½®ä¿®æ”¹å½±å“åˆ†æ

## âœ… ä¸ä¼šæœ‰çš„å½±å“

### 1. æ•°æ®å®‰å…¨
- âœ… **ç°æœ‰æ¶ˆæ¯ä¸ä¼šä¸¢å¤±**
- âœ… **æ¶ˆæ¯å†…å®¹ä¸ä¼šæ”¹å˜**
- âœ… **é˜Ÿåˆ—ä¸ä¼šè¢«åˆ é™¤æˆ–é‡å»º**
- âœ… **æ¶ˆè´¹è€…è¿æ¥ä¸ä¼šä¸­æ–­**

### 2. é˜Ÿåˆ—å±æ€§
- âœ… é˜Ÿåˆ—åç§°ä¸å˜
- âœ… é˜Ÿåˆ—çš„ durableã€exclusive ç­‰åŸºæœ¬å±æ€§ä¸å˜
- âœ… ç»‘å®šå…³ç³»ï¼ˆbindingsï¼‰ä¿æŒä¸å˜
- âœ… æƒé™é…ç½®ä¿æŒä¸å˜

## âš ï¸ ä¼šæœ‰çš„å½±å“

### 1. ç­–ç•¥ä¼šåº”ç”¨åˆ°ç°æœ‰é˜Ÿåˆ—

**é»˜è®¤è¡Œä¸ºï¼š** ç­–ç•¥ä¼šè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰é˜Ÿåˆ—ï¼ˆåŒ…æ‹¬ç°æœ‰é˜Ÿåˆ—ï¼‰

```
ç°æœ‰é˜Ÿåˆ—é…ç½®ï¼š{}
â†“
åº”ç”¨ç­–ç•¥åï¼š{
  "x-dead-letter-exchange": "dlx.exchange",
  "x-message-ttl": 3600000,
  "x-max-length": 100000
}
```

### 2. å¯èƒ½çš„å½±å“åœºæ™¯

#### åœºæ™¯ Aï¼šåŸæœ¬æ²¡æœ‰æ¶ˆæ¯ TTL çš„é˜Ÿåˆ—
**å½±å“ï¼š** æ¶ˆæ¯ä¼šåœ¨ 1 å°æ—¶åè¿‡æœŸï¼ˆå¦‚æœæœªæ¶ˆè´¹ï¼‰

**æ˜¯å¦æœ‰é£é™©ï¼š** 
- å¦‚æœæ¶ˆè´¹è€…æ­£å¸¸è¿è¡Œï¼šâœ… æ— å½±å“
- å¦‚æœæ¶ˆè´¹è€…åœæ­¢ï¼šâš ï¸ æ¶ˆæ¯å¯èƒ½è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# è°ƒæ•´ TTL ä¸ºæ›´é•¿æ—¶é—´
RABBITMQ_MESSAGE_TTL=86400000  # 24 å°æ—¶
```

#### åœºæ™¯ Bï¼šåŸæœ¬æ²¡æœ‰æ­»ä¿¡äº¤æ¢æœºçš„é˜Ÿåˆ—
**å½±å“ï¼š** Nack çš„æ¶ˆæ¯ä¼šå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—

**æ˜¯å¦æœ‰é£é™©ï¼š** âœ… è¿™æ˜¯**å¥½äº‹**ï¼Œä¹‹å‰å¯èƒ½ä¸¢å¤±çš„æ¶ˆæ¯ç°åœ¨ä¼šè¢«ä¿å­˜

#### åœºæ™¯ Cï¼šåŸæœ¬æœ‰æ˜¾å¼é…ç½®çš„é˜Ÿåˆ—
**å½±å“ï¼š** âœ… **é˜Ÿåˆ—è‡ªå·±çš„é…ç½®ä¼˜å…ˆçº§æ›´é«˜**ï¼Œç­–ç•¥ä¸ä¼šè¦†ç›–

```go
// ä¾‹å¦‚ï¼šä»£ç ä¸­å£°æ˜é˜Ÿåˆ—æ—¶å¸¦äº†å‚æ•°
args := amqp.Table{
    "x-message-ttl": 7200000,  // è¿™ä¸ªé…ç½®ä¼˜å…ˆçº§æ›´é«˜
}
channel.QueueDeclare("my.queue", true, false, false, false, args)
// ç­–ç•¥çš„ TTL ä¸ä¼šåº”ç”¨åˆ°è¿™ä¸ªé˜Ÿåˆ—
```

## ğŸ”§ å¦‚ä½•é¿å…å½±å“ç°æœ‰é˜Ÿåˆ—

### æ–¹æ¡ˆ 1ï¼šå…ˆç¦ç”¨è‡ªåŠ¨ç­–ç•¥ï¼ˆæ¨èï¼‰â­

```bash
# åœ¨ rabbitmq/.env ä¸­è®¾ç½®
RABBITMQ_AUTO_POLICY=false

# å¯åŠ¨å®¹å™¨ï¼ˆåªåˆ›å»ºæ­»ä¿¡åŸºç¡€è®¾æ–½ï¼Œä¸åº”ç”¨ç­–ç•¥ï¼‰
docker-compose -f rabbitmq/compose.yaml up -d --build

# ç°æœ‰é˜Ÿåˆ—ä¸å—å½±å“
# åªæœ‰æ–°å»ºçš„é˜Ÿåˆ—æ‰ä¼šæ‰‹åŠ¨é…ç½®
```

### æ–¹æ¡ˆ 2ï¼šé’ˆå¯¹æ€§åº”ç”¨ç­–ç•¥

```bash
# åªå¯¹ç‰¹å®šé˜Ÿåˆ—åº”ç”¨ç­–ç•¥ï¼ˆé€šè¿‡æ­£åˆ™åŒ¹é…ï¼‰
docker exec rabbitmq_01 rabbitmqctl set_policy \
  -p cw_platform_test \
  "auto-retry-policy" \
  "^new\\..*"  # åªåŒ¹é… new. å¼€å¤´çš„é˜Ÿåˆ—
  '{"dead-letter-exchange":"dlx.exchange"}' \
  --priority 1 \
  --apply-to queues
```

### æ–¹æ¡ˆ 3ï¼šè°ƒæ•´å‚æ•°é¿å…å½±å“

```bash
# è®¾ç½®éå¸¸å¤§çš„ TTLï¼Œå®é™…ä¸Šä¸ä¼šè¿‡æœŸ
RABBITMQ_MESSAGE_TTL=2592000000  # 30 å¤©

# è®¾ç½®éå¸¸å¤§çš„é˜Ÿåˆ—é•¿åº¦
RABBITMQ_MAX_LENGTH=10000000  # 1000 ä¸‡
```

## ğŸ“Š å½±å“å¯¹æ¯”è¡¨

| åœºæ™¯ | é»˜è®¤ç­–ç•¥ (AUTO_POLICY=true) | ç¦ç”¨ç­–ç•¥ (AUTO_POLICY=false) |
|------|---------------------------|----------------------------|
| ç°æœ‰é˜Ÿåˆ— | âš ï¸ è‡ªåŠ¨åº”ç”¨ç­–ç•¥ | âœ… ä¸å—å½±å“ |
| æ–°å»ºé˜Ÿåˆ— | âœ… è‡ªåŠ¨åº”ç”¨ç­–ç•¥ | âš ï¸ éœ€è¦æ‰‹åŠ¨é…ç½® |
| æ­»ä¿¡åŸºç¡€è®¾æ–½ | âœ… è‡ªåŠ¨åˆ›å»º | âœ… è‡ªåŠ¨åˆ›å»º |
| è¿ç§»å¤æ‚åº¦ | âš ï¸ éœ€è¦éªŒè¯ | âœ… ç®€å• |

## ğŸ” éªŒè¯æ­¥éª¤

### æ­¥éª¤ 1ï¼šå¯åŠ¨å‰å¤‡ä»½

```bash
# 1. å¤‡ä»½å½“å‰é…ç½®
docker exec rabbitmq_01 rabbitmqctl export_definitions /tmp/backup.json
docker cp rabbitmq_01:/tmp/backup.json ./rabbitmq-backup-$(date +%Y%m%d).json

# 2. æŸ¥çœ‹ç°æœ‰é˜Ÿåˆ—é…ç½®
./command/mq-list.sh detail > current-queues.txt
```

### æ­¥éª¤ 2ï¼šå…ˆç¦ç”¨ç­–ç•¥å¯åŠ¨

```bash
# åˆ›å»º .env æ–‡ä»¶ï¼Œç¦ç”¨è‡ªåŠ¨ç­–ç•¥
cat > rabbitmq/.env <<EOF
RABBITMQ_AUTO_POLICY=false
EOF

# å¯åŠ¨å®¹å™¨
docker-compose -f rabbitmq/compose.yaml up -d --build
```

### æ­¥éª¤ 3ï¼šéªŒè¯ç°æœ‰é˜Ÿåˆ—

```bash
# æŸ¥çœ‹ç°æœ‰é˜Ÿåˆ—æ˜¯å¦å—å½±å“
./command/mq-list.sh detail

# å¯¹æ¯” current-queues.txtï¼Œç¡®è®¤é…ç½®æ²¡æœ‰å˜åŒ–
```

### æ­¥éª¤ 4ï¼šæµ‹è¯•æ–°é˜Ÿåˆ—

```bash
# æ‰‹åŠ¨ä¸ºæµ‹è¯•é˜Ÿåˆ—åº”ç”¨ç­–ç•¥
docker exec rabbitmq_01 rabbitmqctl set_policy \
  -p cw_platform_test \
  "test-policy" \
  "^test\\..*" \
  '{"dead-letter-exchange":"dlx.exchange"}' \
  --priority 1 \
  --apply-to queues

# åˆ›å»ºæµ‹è¯•é˜Ÿåˆ—å¹¶éªŒè¯
```

### æ­¥éª¤ 5ï¼šé€æ­¥å¯ç”¨

```bash
# ç¡®è®¤æ— é—®é¢˜åï¼Œå¯ç”¨å…¨å±€ç­–ç•¥
cat > rabbitmq/.env <<EOF
RABBITMQ_AUTO_POLICY=true
EOF

# é‡å¯å®¹å™¨
docker-compose -f rabbitmq/compose.yaml restart
```

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒ â­

```bash
# 1. å…ˆç¦ç”¨è‡ªåŠ¨ç­–ç•¥
RABBITMQ_AUTO_POLICY=false

# 2. å¯åŠ¨å®¹å™¨
docker-compose -f rabbitmq/compose.yaml up -d --build

# 3. éªŒè¯ç°æœ‰é˜Ÿåˆ—æ­£å¸¸å·¥ä½œ

# 4. é’ˆå¯¹æ–°ä¸šåŠ¡é˜Ÿåˆ—æ‰‹åŠ¨åº”ç”¨ç­–ç•¥
```

### å¦‚æœæ˜¯å¼€å‘/æµ‹è¯•ç¯å¢ƒ

```bash
# ç›´æ¥å¯ç”¨ï¼Œå¿«é€Ÿæµ‹è¯•
RABBITMQ_AUTO_POLICY=true

# å¦‚æœ‰é—®é¢˜ï¼Œå¯ä»¥éšæ—¶åˆ é™¤ç­–ç•¥
docker exec rabbitmq_01 rabbitmqctl clear_policy -p cw_platform_test auto-retry-policy
```

## ğŸ†˜ å¦‚ä½•å›æ»š

### åˆ é™¤ç­–ç•¥ï¼ˆä¸å½±å“é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼‰

```bash
# åˆ é™¤ç­–ç•¥
docker exec rabbitmq_01 rabbitmqctl clear_policy \
  -p cw_platform_test \
  auto-retry-policy

# ç­–ç•¥åˆ é™¤åï¼Œé˜Ÿåˆ—æ¢å¤åŸå§‹é…ç½®
# æ¶ˆæ¯å’Œæ•°æ®ä¸å—å½±å“
```

### å®Œå…¨å›æ»š

```bash
# 1. åœæ­¢å®¹å™¨
docker-compose -f rabbitmq/compose.yaml down

# 2. æ¢å¤å¤‡ä»½çš„é…ç½®
docker exec rabbitmq_01 rabbitmqctl import_definitions /path/to/backup.json

# 3. æˆ–ä½¿ç”¨æ—§çš„é•œåƒ
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒå‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²å¤‡ä»½å½“å‰é…ç½®
- [ ] å·²äº†è§£ç­–ç•¥ä¼šåº”ç”¨åˆ°ç°æœ‰é˜Ÿåˆ—
- [ ] å·²è¯„ä¼° TTL é…ç½®çš„å½±å“
- [ ] å·²åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- [ ] æ¶ˆè´¹è€…ä»£ç å·²æ›´æ–°ï¼ˆæ”¯æŒé‡è¯•é€»è¾‘ï¼‰
- [ ] å·²è®¾ç½®ç›‘æ§å’Œå‘Šè­¦
- [ ] å›¢é˜Ÿå·²äº†è§£å˜æ›´å†…å®¹

## ğŸ’¡ æ€»ç»“

**ç®€å•å›ç­”ï¼š** 

âœ… **æ•°æ®ä¸ä¼šä¸¢å¤±**ï¼Œæ¶ˆæ¯ä¸ä¼šä¸¢å¤±  
âš ï¸ **ç­–ç•¥ä¼šåº”ç”¨åˆ°ç°æœ‰é˜Ÿåˆ—**ï¼Œä½†å¯ä»¥é€šè¿‡ `RABBITMQ_AUTO_POLICY=false` ç¦ç”¨  
âœ… **å¯ä»¥éšæ—¶å›æ»š**ï¼Œåˆ é™¤ç­–ç•¥å³å¯  

**æ¨èï¼š**
- ç”Ÿäº§ç¯å¢ƒï¼šå…ˆè®¾ç½® `RABBITMQ_AUTO_POLICY=false`ï¼Œé€æ­¥è¿ç§»
- æµ‹è¯•ç¯å¢ƒï¼šç›´æ¥å¯ç”¨ `RABBITMQ_AUTO_POLICY=true`ï¼Œå¿«é€ŸéªŒè¯

